from flask import Flask, render_template, request
import pandas as pd
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import io
import base64

app = Flask(__name__)
data = pd.read_csv('data.csv')

@app.route('/')
def home():
    return render_template('form.html')

@app.route('/student', methods=['POST'])
def student():
    student_id = request.form.get('student_id')
    if not student_id or not student_id.isdigit():
        return render_template('error.html', message="Invalid student id!")
    student_id = int(student_id)
    stud_data = data[data['Student id'] == student_id]
    if stud_data.empty:
        return render_template('error.html', message="Student id not found!")
    return render_template('student.html', tables=[stud_data.to_html(index=False)], titles=[''])

@app.route('/course', methods=['POST'])
def course():
    course_id = request.form.get('course_id')
    if not course_id or not course_id.isdigit():
        return render_template('error.html', message="Invalid course id!")
    course_id = int(course_id)
    course_data = data[data['Course id'] == course_id]
    if course_data.empty:
        return render_template('error.html', message="Course id not found!")
    # Generate bar chart
    plt.figure()
    plt.bar(course_data['Student id'], course_data['Marks'])
    plt.xlabel('Student id')
    plt.ylabel('Marks')
    plt.title(f'Course {course_id} Marks')
    buf = io.BytesIO()
    plt.savefig(buf, format='png')
    plt.close()
    buf.seek(0)
    chart = base64.b64encode(buf.getvalue()).decode()
    return render_template('course.html', course_id=course_id, chart=chart, tables=[course_data.to_html(index=False)], titles=[''])

# Error template route (optional)
@app.route('/error')
def error():
    message = request.args.get('message', "Error!")
    return render_template('error.html', message=message)

if __name__ == '__main__':
    app.run(debug=True)
